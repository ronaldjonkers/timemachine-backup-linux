# TimeMachine Backup Configuration
# Copy this file to .env and adjust values

# ============================================================
# GENERAL
# ============================================================
# Backup user (runs all backup operations)
TM_USER="timemachine"

# Base directory for TimeMachine installation
TM_HOME="/home/timemachine"

# Directory where backups are stored
TM_BACKUP_ROOT="/backups"

# Number of daily snapshots to retain (rotating)
TM_RETENTION_DAYS=7

# ============================================================
# SSH
# ============================================================
# Path to SSH private key used for connecting to clients
TM_SSH_KEY="/home/timemachine/.ssh/id_rsa"

# SSH port (default 22)
TM_SSH_PORT=22

# SSH connection timeout in seconds
TM_SSH_TIMEOUT=10

# ============================================================
# RSYNC
# ============================================================
# Additional rsync options (space-separated)
TM_RSYNC_EXTRA_OPTS=""

# Rsync bandwidth limit in KB/s (0 = unlimited)
TM_RSYNC_BW_LIMIT=0

# ============================================================
# FILE BACKUP
# ============================================================
# Root path to back up on remote servers. Default "/" syncs the
# entire filesystem. What gets excluded is controlled by
# config/exclude.conf (global) and config/exclude.<hostname>.conf
# (per-server). Only change this if you want to limit the backup
# to a specific subtree (e.g. "/home/").
TM_BACKUP_SOURCE="/"

# ============================================================
# DATABASE BACKUP
# ============================================================
# Which database engines to dump: "auto" (detect installed),
# or comma-separated list: mysql,postgresql,mongodb,redis,sqlite
TM_DB_TYPES="auto"

# --- Credential Storage ---
# All database credentials are stored in a single directory.
# Each file has mode 600, owned by the timemachine user.
#   mysql.pw         — MySQL/MariaDB root password (single line)
#   mongodb.conf     — MongoDB credentials (format: username:password)
#   redis.pw         — Redis password (single line)
#   pgpass           — PostgreSQL pgpass file (host:port:db:user:pass)
TM_CREDENTIALS_DIR="/home/timemachine/.credentials"

# --- MySQL / MariaDB ---
# Path to MySQL root password file on remote servers
# Create with: echo 'yourpassword' | sudo tee /home/timemachine/.credentials/mysql.pw && sudo chmod 600 /home/timemachine/.credentials/mysql.pw
TM_MYSQL_PW_FILE="/home/timemachine/.credentials/mysql.pw"

# MySQL host flag (empty = use socket, or e.g. "localhost", "127.0.0.1")
TM_MYSQL_HOST=""

# --- PostgreSQL ---
# System user that can run pg_dump (usually "postgres")
# Uses peer authentication by default (no password needed)
TM_PG_USER="postgres"

# PostgreSQL host (empty = use socket)
TM_PG_HOST=""

# --- MongoDB ---
# MongoDB host (empty = localhost default)
TM_MONGO_HOST=""

# Authentication database for MongoDB
TM_MONGO_AUTH_DB="admin"

# MongoDB credentials file on client: /home/timemachine/.credentials/mongodb.conf
# Format: username:password (one line, chmod 600)

# --- Redis ---
# Redis host (empty = localhost)
TM_REDIS_HOST=""

# Redis port
TM_REDIS_PORT=6379

# Redis backup is OPT-IN: it is skipped unless a credential file exists.
# To enable Redis backup on a client, create one of these files:
#   touch /home/timemachine/.credentials/redis.conf     (no password)
#   echo 'pass' > /home/timemachine/.credentials/redis.pw  (with password)

# --- SQLite ---
# Comma-separated paths to SQLite database files on remote servers
# Example: "/var/lib/app/db.sqlite3,/opt/wiki/data.db"
TM_SQLITE_PATHS=""

# Number of retries for failed database dumps
TM_DB_DUMP_RETRIES=3

# Compress SQL dump files with gzip before rsync (saves bandwidth)
# true = compress (default, recommended), false = keep raw .sql files
TM_DB_COMPRESS="true"

# ============================================================
# PARALLEL EXECUTION
# ============================================================
# Max number of parallel backup jobs
TM_PARALLEL_JOBS=5

# ============================================================
# NOTIFICATIONS
# ============================================================
# Enable/disable notifications globally (true/false)
TM_ALERT_ENABLED=false

# Notification methods (comma-separated): email, webhook, slack
TM_NOTIFY_METHODS="email"

# Mail subject prefix
TM_ALERT_SUBJECT_PREFIX="[TimeMachine]"

# Default email address for alerts (comma-separated for multiple)
TM_ALERT_EMAIL=""

# Per-event enable/disable (all enabled by default when alerts are on)
TM_NOTIFY_BACKUP_OK=true
TM_NOTIFY_BACKUP_FAIL=true
TM_NOTIFY_DAILY_REPORT=true
TM_NOTIFY_RESTORE_OK=true
TM_NOTIFY_RESTORE_FAIL=true

# Per-event email overrides (leave empty to use TM_ALERT_EMAIL)
TM_ALERT_EMAIL_BACKUP_OK=""
TM_ALERT_EMAIL_BACKUP_FAIL=""
TM_ALERT_EMAIL_RESTORE_OK=""
TM_ALERT_EMAIL_RESTORE_FAIL=""

# HTTP POST webhook URL (receives JSON payload)
TM_WEBHOOK_URL=""

# Optional extra headers for webhook (e.g., "Authorization: Bearer TOKEN")
TM_WEBHOOK_HEADERS=""

# Slack incoming webhook URL
TM_SLACK_WEBHOOK_URL=""

# --- SMTP Relay (recommended — no local MTA needed) ---
# Configure these to send email via an external SMTP server.
# Works with Gmail (use App Password), Mailgun, SendGrid, Amazon SES, etc.
# Port 587 = STARTTLS (default), Port 465 = SSL/TLS
TM_SMTP_HOST=""
TM_SMTP_PORT=587
TM_SMTP_USER=""
TM_SMTP_PASS=""
TM_SMTP_FROM=""
TM_SMTP_TLS="true"

# ============================================================
# LOGGING
# ============================================================
# Log level: DEBUG, INFO, WARN, ERROR
TM_LOG_LEVEL="INFO"

# Log directory
TM_LOG_DIR="/home/timemachine/logs"

# ============================================================
# PID / LOCK FILES
# ============================================================
TM_RUN_DIR="/var/run/timemachine"

# ============================================================
# ENCRYPTION
# ============================================================
# Enable backup encryption (true/false)
TM_ENCRYPT_ENABLED=false

# Encryption mode: "symmetric" (passphrase) or "asymmetric" (GPG key)
TM_ENCRYPT_MODE="symmetric"

# Passphrase for symmetric encryption
TM_ENCRYPT_PASSPHRASE=""

# GPG key ID for asymmetric encryption
TM_ENCRYPT_KEY_ID=""

# Remove unencrypted backup after encryption (true/false)
TM_ENCRYPT_REMOVE_ORIGINAL=false

# ============================================================
# SERVICE / API
# ============================================================
# HTTP API port for the TimeMachine service daemon
TM_API_PORT=7600

# HTTP API bind address (0.0.0.0 = all interfaces)
TM_API_BIND="0.0.0.0"

# ============================================================
# SCHEDULER
# ============================================================
# Hour of day to trigger daily backups (24h format)
TM_SCHEDULE_HOUR=11
# Minute of the hour to trigger daily backups (0, 15, 30, 45)
TM_SCHEDULE_MINUTE=0

# Maximum allowed time for daily backup run (seconds, default 86400 = 24h)
# If the daily run exceeds this, an overrun alert is sent with per-server status
TM_MAX_DAILY_SECONDS=86400
