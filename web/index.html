<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeMachine Backup</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>&#x23f0;</text></svg>">
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">&#x23f0;</span>
                <span class="logo-text">TimeMachine</span>
            </div>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-page="dashboard" onclick="showPage('dashboard')">&#x1F4CA; Dashboard</button>
                <button class="nav-tab" data-page="servers" onclick="showPage('servers')">&#x1F4E1; Servers</button>
                <button class="nav-tab" data-page="archive" onclick="showPage('archive')">&#x1F4E6; Archive</button>
                <button class="nav-tab" data-page="restores" onclick="showPage('restores')">&#x1F501; Restores</button>
                <button class="nav-tab" data-page="settings" onclick="showPage('settings')">&#x2699; Settings</button>
                <button class="nav-tab" data-page="help" onclick="showPage('help')">&#x2753; Help</button>
            </nav>
            <div id="service-status" class="badge badge-unknown">
                <span class="pulse"></span>
                <span class="badge-text">Connecting...</span>
            </div>
        </div>
    </header>

    <main>
        <!-- ============================================================
             PAGE: DASHBOARD
             ============================================================ -->
        <div class="page active" id="page-dashboard">

            <!-- Row 1: Service info cards -->
            <section class="cards cards-3">
                <div class="card">
                    <div class="card-icon">&#x1F5A5;</div>
                    <div class="card-body">
                        <div class="card-label">Hostname</div>
                        <div class="card-value" id="hostname">--</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-icon">&#x26A1;</div>
                    <div class="card-body">
                        <div class="card-label">Active Jobs</div>
                        <div class="card-value" id="active-jobs">0</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-icon">&#x1F4E1;</div>
                    <div class="card-body">
                        <div class="card-label">Servers</div>
                        <div class="card-value" id="server-count">0</div>
                    </div>
                </div>
            </section>

            <!-- Row 2: System metrics -->
            <section class="cards">
                <div class="card">
                    <div class="card-icon">&#x1F4BB;</div>
                    <div class="card-body">
                        <div class="card-label">CPU Load (1m)</div>
                        <div class="card-value" id="sys-load1">--</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-icon">&#x1F4CA;</div>
                    <div class="card-body">
                        <div class="card-label">CPU Load (5m)</div>
                        <div class="card-value" id="sys-load5">--</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-icon">&#x1F9E0;</div>
                    <div class="card-body" style="flex:1">
                        <div class="card-label">Memory</div>
                        <div class="card-value"><span id="sys-mem-used">--</span><span class="card-unit" id="sys-mem-detail"></span></div>
                        <div class="progress-bar progress-bar-sm">
                            <div class="progress-fill" id="mem-bar" style="width:0%"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-icon">&#x1F4BE;</div>
                    <div class="card-body" style="flex:1">
                        <div class="card-label">Disk Usage <small id="disk-mount" style="opacity:.6"></small></div>
                        <div class="disk-row">
                            <span class="card-value" id="disk-used">--</span>
                            <span class="disk-detail" id="disk-detail">/ --</span>
                        </div>
                        <div class="progress-bar progress-bar-sm">
                            <div class="progress-fill" id="disk-bar" style="width:0%"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- No Backups Today Banner -->
            <section class="panel" id="no-backups-banner" style="display:none">
                <div class="panel-header panel-header-danger">
                    <h2>&#x23F0; No backups have run today</h2>
                    <button class="btn btn-sm btn-success" onclick="startAllBackups()">Start All Backups Now</button>
                </div>
            </section>

            <!-- Failed Backups -->
            <section class="panel" id="failures-panel" style="display:none">
                <div class="panel-header panel-header-danger">
                    <h2>&#x26A0; Failed Backups</h2>
                    <button class="btn btn-sm" onclick="refreshFailures()">Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Server</th>
                            <th>Error</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="failures-body">
                        <tr><td colspan="3" class="empty">No failures detected</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Backup Processes -->
            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F504; Backup Processes</h2>
                    <div>
                        <button class="btn btn-sm btn-danger" id="processes-clear-btn" style="display:none" onclick="clearProcesses()">Clear Finished</button>
                        <button class="btn btn-sm" onclick="refreshProcesses()">Refresh</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Hostname</th>
                            <th>PID</th>
                            <th>Mode</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="processes-body">
                        <tr><td colspan="7" class="empty">No active processes</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Client Installer -->
            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F4E5; Add New Client</h2>
                    <button class="btn btn-sm" onclick="copyInstaller()">Copy</button>
                </div>
                <div class="installer-block">
                    <div class="installer-label">Run this on any server to add it as a backup client:</div>
                    <pre id="installer-cmd" class="code-block">Loading...</pre>
                </div>
                <div class="hint">
                    This one-liner downloads the installer, adds this server's SSH key, and sets up the backup agent.
                </div>
            </section>

            <!-- Quick Backup -->
            <section class="panel">
                <div class="panel-header">
                    <h2>&#x26A1; Quick Backup</h2>
                </div>
                <div class="quick-action">
                    <input type="text" id="backup-hostname" placeholder="hostname.example.com">
                    <select id="backup-mode">
                        <option value="">Full (files + DB)</option>
                        <option value="?files-only">Files only</option>
                        <option value="?db-only">Database only</option>
                    </select>
                    <button class="btn btn-primary" onclick="startBackup()">Start Backup</button>
                </div>
            </section>

            <!-- System Info (moved from Settings) -->
            <section class="panel">
                <div class="panel-header">
                    <h2>&#x2699; System Info</h2>
                </div>
                <div class="sysinfo-grid">
                    <div class="sysinfo-item">
                        <span class="sysinfo-label">Operating System</span>
                        <span class="sysinfo-value" id="sys-os">--</span>
                    </div>
                    <div class="sysinfo-item">
                        <span class="sysinfo-label">Kernel</span>
                        <span class="sysinfo-value" id="sys-kernel">--</span>
                    </div>
                    <div class="sysinfo-item">
                        <span class="sysinfo-label">CPU Cores</span>
                        <span class="sysinfo-value" id="sys-cpus">--</span>
                    </div>
                    <div class="sysinfo-item">
                        <span class="sysinfo-label">Total Memory</span>
                        <span class="sysinfo-value" id="sys-mem-total">--</span>
                    </div>
                    <div class="sysinfo-item">
                        <span class="sysinfo-label">System Uptime</span>
                        <span class="sysinfo-value" id="sys-uptime">--</span>
                    </div>
                    <div class="sysinfo-item">
                        <span class="sysinfo-label">Load Average</span>
                        <span class="sysinfo-value" id="sys-load-full">--</span>
                    </div>
                </div>
            </section>

        </div>

        <!-- ============================================================
             PAGE: SERVERS
             ============================================================ -->
        <div class="page" id="page-servers">

            <!-- Configured Servers with backup history -->
            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F4E1; Servers &amp; Backup History</h2>
                    <div class="panel-header-actions">
                        <input type="text" id="server-search" class="search-input" placeholder="&#x1F50D; Search servers..." oninput="_renderServersTable()">
                        <button class="btn btn-sm" id="toggle-add-server" onclick="toggleAddServer()">+ Add Server</button>
                    </div>
                </div>
                <div class="quick-action hidden" id="add-server-form">
                    <input type="text" id="add-server-hostname" placeholder="hostname.example.com">
                    <select id="add-server-options">
                        <option value="">Full (files + DB)</option>
                        <option value="--files-only">Files only</option>
                        <option value="--db-only">Database only</option>
                        <option value="--no-rotate">No rotation</option>
                    </select>
                    <input type="number" id="add-server-priority" placeholder="Priority 1=high" min="1" max="99" style="width:130px" title="1 = highest priority, default 10">
                    <input type="number" id="add-server-db-interval" placeholder="DB interval (h)" min="1" max="24" style="width:130px">
                    <button class="btn btn-primary" onclick="addServer()">Add Server</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="hostname" onclick="sortServers('hostname')">Hostname <span class="sort-arrow"></span></th>
                            <th class="sortable" data-sort="priority" onclick="sortServers('priority')" title="1 = highest priority">Priority <span class="sort-arrow">&#x25B2;</span></th>
                            <th class="sortable" data-sort="last_backup" onclick="sortServers('last_backup')">Last Backup <span class="sort-arrow"></span></th>
                            <th>Snapshots</th>
                            <th>Total Size</th>
                            <th class="sortable" data-sort="status" onclick="sortServers('status')">Status <span class="sort-arrow"></span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="servers-body">
                        <tr><td colspan="7" class="empty">Loading...</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Server Detail (shown when clicking a server) -->
            <section class="panel" id="server-detail-panel" style="display:none">
                <div class="panel-header">
                    <h2 id="server-detail-title">&#x1F5A5; Server Details</h2>
                    <button class="btn btn-sm" onclick="closeServerDetail()">Close</button>
                </div>
                <div id="server-detail-body"></div>
            </section>

        </div>

        <!-- ============================================================
             PAGE: RESTORES
             ============================================================ -->
        <div class="page" id="page-restores">

            <section class="panel" id="restores-panel">
                <div class="panel-header">
                    <h2>&#x1F501; Restore History <span class="text-muted" style="font-size:0.75rem;font-weight:400">(last 30 days)</span></h2>
                    <div>
                        <button class="btn btn-sm btn-danger" id="restores-clear-btn" style="display:none" onclick="clearFinishedRestores()">Clear All</button>
                        <button class="btn btn-sm" onclick="refreshRestores()">Refresh</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Server</th>
                            <th>Description</th>
                            <th>Started</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="restores-body">
                        <tr><td colspan="5" class="empty">No restore tasks</td></tr>
                    </tbody>
                </table>
            </section>

        </div>

        <!-- ============================================================
             PAGE: ARCHIVE
             ============================================================ -->
        <div class="page" id="page-archive">

            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F4E6; Archived Servers</h2>
                    <button class="btn btn-sm" onclick="refreshArchived()">Refresh</button>
                </div>
                <p class="text-muted" style="padding:0 1.25rem 0.5rem">
                    Archived servers are no longer backed up daily but their existing snapshots are preserved. You can browse snapshots, restore from archive, re-activate a server, or permanently delete all data.
                </p>
                <table>
                    <thead>
                        <tr>
                            <th>Hostname</th>
                            <th>Last Backup</th>
                            <th>Snapshots</th>
                            <th>Total Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="archived-body">
                        <tr><td colspan="5" class="empty">No archived servers</td></tr>
                    </tbody>
                </table>
            </section>

            <!-- Background deletion tasks -->
            <section class="panel" id="delete-tasks-panel" style="display:none">
                <div class="panel-header">
                    <h2>&#x1F5D1; Background Deletions</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Hostname</th>
                            <th>Status</th>
                            <th>Started</th>
                        </tr>
                    </thead>
                    <tbody id="delete-tasks-body"></tbody>
                </table>
            </section>

        </div>

        <!-- ============================================================
             PAGE: SETTINGS
             ============================================================ -->
        <div class="page" id="page-settings">

            <!-- Backup Settings -->
            <section class="panel">
                <div class="panel-header">
                    <h2>&#x23F0; Backup Schedule</h2>
                </div>
                <div class="settings-form">
                    <div class="settings-row">
                        <div class="settings-field">
                            <label for="setting-schedule-hour">Daily backup start time</label>
                            <div class="settings-input-group">
                                <input type="number" id="setting-schedule-hour" min="0" max="23" value="11" style="width:80px">
                                <span class="text-muted">:</span>
                                <select id="setting-schedule-minute" style="width:70px;padding:0.45rem 0.5rem;background:var(--bg-card);color:var(--text);border:1px solid var(--border);border-radius:var(--radius-sm)">
                                    <option value="0">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                                <span class="text-muted">(24h format)</span>
                            </div>
                        </div>
                        <div class="settings-field">
                            <label for="setting-retention-days">Retention (days)</label>
                            <div class="settings-input-group">
                                <input type="number" id="setting-retention-days" min="1" max="365" value="7" style="width:80px">
                                <span class="text-muted">snapshots older than this are deleted</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-field">
                            <label for="setting-parallel-jobs">Parallel backup jobs</label>
                            <div class="settings-input-group">
                                <input type="number" id="setting-parallel-jobs" min="1" max="50" value="5" style="width:80px">
                                <span class="text-muted">max simultaneous backups</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-primary" onclick="saveSettings()">Save All Settings</button>
                        <span class="text-muted" id="schedule-settings-status"></span>
                    </div>
                </div>
            </section>

            <!-- Exclude Patterns -->
            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F6AB; Exclude Patterns</h2>
                </div>
                <div class="settings-form">
                    <p class="text-muted" style="margin:0 0 0.75rem">
                        Paths and patterns listed here are excluded from rsync file backups.
                        One pattern per line. Lines starting with <code>#</code> are comments.
                        Use rsync exclude syntax: <code>/path</code> for absolute, <code>*.ext</code> for wildcards, <code>dir/</code> for directories.
                    </p>

                    <div class="settings-field">
                        <label for="exclude-global"><strong>Global excludes</strong> <small class="text-muted">(apply to all servers)</small></label>
                        <textarea id="exclude-global" class="code-textarea" rows="10" spellcheck="false" placeholder="# Example:&#10;/tmp&#10;/var/cache&#10;*.swap"></textarea>
                        <div style="margin-top:0.5rem">
                            <button class="btn btn-primary btn-sm" onclick="saveExcludes()">Save Global Excludes</button>
                            <span class="text-muted" id="exclude-global-status"></span>
                        </div>
                    </div>

                    <div class="settings-field" style="margin-top:1.25rem">
                        <label><strong>Per-server excludes</strong> <small class="text-muted">(additional patterns for a specific server)</small></label>
                        <p class="text-muted" style="margin:0.25rem 0 0.5rem;font-size:0.85rem">
                            Select a server to edit its extra exclude patterns. These are <em>added</em> to the global excludes &mdash; they do not replace them.
                        </p>
                        <div class="settings-input-group" style="margin-bottom:0.5rem">
                            <select id="exclude-server-select" onchange="loadServerExcludes()" style="padding:0.45rem 0.5rem;background:var(--bg-card);color:var(--text);border:1px solid var(--border);border-radius:var(--radius-sm);min-width:200px">
                                <option value="">-- select server --</option>
                            </select>
                        </div>
                        <textarea id="exclude-server" class="code-textarea" rows="6" spellcheck="false" placeholder="# Extra excludes for this server only&#10;# e.g. /var/lib/large-app/cache" disabled></textarea>
                        <div style="margin-top:0.5rem">
                            <button class="btn btn-primary btn-sm" onclick="saveServerExcludes()" id="btn-save-server-excludes" disabled>Save Server Excludes</button>
                            <span class="text-muted" id="exclude-server-status"></span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Notification Settings -->
            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F514; Notifications</h2>
                </div>
                <div class="settings-form">
                    <div class="settings-row">
                        <div class="settings-field">
                            <label>
                                <input type="checkbox" id="setting-alert-enabled">
                                Enable email notifications
                            </label>
                        </div>
                        <div class="settings-field">
                            <label for="setting-alert-email">Default email address</label>
                            <input type="email" id="setting-alert-email" placeholder="admin@example.com" class="settings-text-input">
                        </div>
                    </div>

                    <div class="settings-section-title">Per-event notifications</div>
                    <table class="settings-table">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Enabled</th>
                                <th>Email override <span class="text-muted">(leave empty for default)</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Backup success</td>
                                <td><input type="checkbox" id="setting-notify-backup-ok" checked></td>
                                <td><input type="email" id="setting-email-backup-ok" placeholder="ops@example.com" class="settings-text-input"></td>
                            </tr>
                            <tr>
                                <td>Backup failure</td>
                                <td><input type="checkbox" id="setting-notify-backup-fail" checked></td>
                                <td><input type="email" id="setting-email-backup-fail" placeholder="oncall@example.com" class="settings-text-input"></td>
                            </tr>
                            <tr>
                                <td>Restore success</td>
                                <td><input type="checkbox" id="setting-notify-restore-ok" checked></td>
                                <td><input type="email" id="setting-email-restore-ok" placeholder="" class="settings-text-input"></td>
                            </tr>
                            <tr>
                                <td>Restore failure</td>
                                <td><input type="checkbox" id="setting-notify-restore-fail" checked></td>
                                <td><input type="email" id="setting-email-restore-fail" placeholder="" class="settings-text-input"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="settings-section-title">SMTP Relay <span class="text-muted">(required for email â€” no local MTA needed)</span></div>
                    <div class="settings-row">
                        <div class="settings-field">
                            <label for="setting-smtp-host">SMTP Host</label>
                            <input type="text" id="setting-smtp-host" placeholder="smtp.gmail.com" class="settings-text-input">
                        </div>
                        <div class="settings-field">
                            <label for="setting-smtp-port">Port</label>
                            <input type="number" id="setting-smtp-port" placeholder="587" class="settings-text-input" style="width:80px">
                        </div>
                        <div class="settings-field">
                            <label>
                                <input type="checkbox" id="setting-smtp-tls" checked>
                                Use TLS
                            </label>
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-field">
                            <label for="setting-smtp-user">Username</label>
                            <input type="text" id="setting-smtp-user" placeholder="user@gmail.com" class="settings-text-input">
                        </div>
                        <div class="settings-field">
                            <label for="setting-smtp-pass">Password</label>
                            <input type="password" id="setting-smtp-pass" placeholder="app password" class="settings-text-input">
                        </div>
                        <div class="settings-field">
                            <label for="setting-smtp-from">From address</label>
                            <input type="email" id="setting-smtp-from" placeholder="backups@example.com" class="settings-text-input">
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-field">
                            <button class="btn btn-sm" onclick="sendTestEmail()">Send Test Email</button>
                            <span class="text-muted" id="test-email-status"></span>
                        </div>
                    </div>

                    <div class="settings-actions">
                        <button class="btn btn-primary" onclick="saveSettings()">Save All Settings</button>
                        <span class="text-muted" id="settings-status"></span>
                    </div>
                </div>
            </section>

            <!-- SSH Key -->
            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F511; SSH Public Key</h2>
                    <button class="btn btn-sm" onclick="copySSHKey()">Copy Key</button>
                </div>
                <pre id="ssh-key" class="code-block">Loading...</pre>
            </section>

        </div>

        <!-- ============================================================
             PAGE: HELP
             ============================================================ -->
        <div class="page" id="page-help">

            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F4D6; Getting Started</h2>
                </div>
                <div class="help-content">
                    <p>TimeMachine creates daily incremental backups of your Linux servers using rsync hardlink snapshots. Each day's backup is a full browsable copy, but only changed files use extra disk space.</p>

                    <h3>Quick Setup (3 steps)</h3>
                    <ol>
                        <li><strong>Install the server</strong> &mdash; You've already done this if you're reading this page.</li>
                        <li><strong>Add a client</strong> &mdash; Run the one-liner from the Dashboard on each server you want to back up.</li>
                        <li><strong>Add the server</strong> &mdash; Go to <em>Servers</em> &rarr; <em>+ Add Server</em> and enter the hostname.</li>
                    </ol>
                    <p>Backups will start automatically at the configured schedule hour (see <em>Settings</em>).</p>
                </div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F5A5; Client Setup</h2>
                </div>
                <div class="help-content">
                    <h3>Adding a backup client</h3>
                    <p>On the remote server you want to back up, run:</p>
                    <pre class="code-block">curl -sSL https://raw.githubusercontent.com/ronaldjonkers/timemachine-backup-linux/main/get.sh | sudo bash -s -- client --server &lt;backup-server-hostname&gt;</pre>
                    <p>This will:</p>
                    <ul>
                        <li>Create the <code>timemachine</code> user</li>
                        <li>Install the SSH public key from the backup server</li>
                        <li>Configure sudoers for passwordless rsync</li>
                        <li>Optionally set up database backup tools</li>
                    </ul>

                    <h3>Backup modes per server</h3>
                    <table class="help-table">
                        <thead><tr><th>Mode</th><th>What it backs up</th><th>Option</th></tr></thead>
                        <tbody>
                            <tr><td><strong>Full</strong></td><td>Files + databases</td><td>(default)</td></tr>
                            <tr><td><strong>Files only</strong></td><td>Filesystem only, skip DB</td><td><code>--files-only</code></td></tr>
                            <tr><td><strong>DB only</strong></td><td>Databases only, skip files</td><td><code>--db-only</code></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F4BE; Database Backup Setup</h2>
                </div>
                <div class="help-content">
                    <p>TimeMachine auto-detects installed database engines on each client. Before each dump, all previous dumps are cleaned from <code>~/sql/</code> to prevent disk space buildup. For authentication, create credential files on the <strong>client server</strong>.</p>

                    <h3>MySQL / MariaDB</h3>
                    <pre class="code-block"># Create password file on the client server:
echo 'your-mysql-root-password' | sudo tee /home/timemachine/.credentials/mysql.pw
sudo chmod 600 /home/timemachine/.credentials/mysql.pw
sudo chown timemachine:timemachine /home/timemachine/.credentials/mysql.pw</pre>
                    <p class="help-note">TimeMachine will dump all databases (except system DBs). The script also checks <code>/root/mysql.pw</code> as fallback. If no password is found, you'll receive an email alert.</p>

                    <h3>PostgreSQL</h3>
                    <pre class="code-block"># PostgreSQL uses peer authentication by default.
# The timemachine user needs sudo access to the postgres user.
# This is configured automatically by the client installer.
# No password file needed for local connections.

# For remote PostgreSQL, set in .env on the backup server:
# TM_PG_HOST="db.example.com"
# And create a pgpass file on the client:
echo "db.example.com:5432:*:postgres:yourpassword" | sudo tee /home/timemachine/.credentials/pgpass
sudo chmod 600 /home/timemachine/.credentials/pgpass</pre>

                    <h3>MongoDB</h3>
                    <pre class="code-block"># Create credentials file on the client server:
echo 'admin_user:admin_password' | sudo tee /home/timemachine/.credentials/mongodb.conf
sudo chmod 600 /home/timemachine/.credentials/mongodb.conf
sudo chown timemachine:timemachine /home/timemachine/.credentials/mongodb.conf</pre>
                    <p class="help-note">Format: <code>username:password</code> on a single line. Uses the <code>admin</code> auth database by default.</p>

                    <h3>Redis (opt-in)</h3>
                    <pre class="code-block"># Redis backup is opt-in. Enable it by creating a credential file:

# Without password:
sudo -u timemachine touch /home/timemachine/.credentials/redis.conf

# With password:
echo 'your-redis-password' | sudo tee /home/timemachine/.credentials/redis.pw
sudo chmod 600 /home/timemachine/.credentials/redis.pw
sudo chown timemachine:timemachine /home/timemachine/.credentials/redis.pw</pre>
                    <p class="help-note">Redis is <strong>skipped</strong> unless <code>redis.conf</code> or <code>redis.pw</code> exists in <code>~/.credentials/</code>. When enabled, TimeMachine triggers a BGSAVE and copies the RDB snapshot file.</p>

                    <h3>SQLite</h3>
                    <pre class="code-block"># Set the paths in .env on the backup server:
# TM_SQLITE_PATHS="/var/lib/app/db.sqlite3,/opt/wiki/data.db"</pre>
                    <p class="help-note">No credentials needed. TimeMachine uses <code>sqlite3 .backup</code> for a safe online copy.</p>

                    <h3>Credential file summary</h3>
                    <table class="help-table">
                        <thead><tr><th>Database</th><th>File on client</th><th>Format</th></tr></thead>
                        <tbody>
                            <tr><td>MySQL/MariaDB</td><td><code>/home/timemachine/.credentials/mysql.pw</code></td><td>Password (single line)</td></tr>
                            <tr><td>PostgreSQL</td><td><code>/home/timemachine/.credentials/pgpass</code></td><td>host:port:db:user:pass</td></tr>
                            <tr><td>MongoDB</td><td><code>/home/timemachine/.credentials/mongodb.conf</code></td><td>username:password</td></tr>
                            <tr><td>Redis</td><td><code>/home/timemachine/.credentials/redis.conf</code> or <code>redis.pw</code></td><td>Empty file (opt-in) or password</td></tr>
                            <tr><td>SQLite</td><td>N/A</td><td>Paths in <code>.env</code></td></tr>
                        </tbody>
                    </table>
                    <p class="help-note">All credential files must be owned by <code>timemachine</code> with permissions <code>600</code>. If a credential file is missing or contains a wrong password, TimeMachine will send an email alert to the configured notification address.</p>

                    <h3>Dump Compression</h3>
                    <p>Database dumps are <strong>gzip-compressed</strong> by default before rsync transfer, significantly reducing bandwidth usage (SQL files typically compress 5-10x). To disable:</p>
                    <pre class="code-block"># In .env on the backup server:
TM_DB_COMPRESS="false"</pre>
                    <p class="help-note">Compression is enabled by default (<code>TM_DB_COMPRESS="true"</code>). It adds a few seconds of CPU time but saves minutes of network transfer for large databases.</p>
                </div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F501; Restoring Backups</h2>
                </div>
                <div class="help-content">
                    <h3>From the web UI</h3>
                    <ol>
                        <li>Go to <em>Servers</em> &rarr; click <strong>Details</strong> on a server</li>
                        <li>Click <strong>Browse</strong> on a snapshot to explore files</li>
                        <li>Click <strong>Restore</strong> on a file, folder, or entire snapshot</li>
                        <li>Track progress on the <em>Restores</em> tab</li>
                    </ol>

                    <h3>From the command line</h3>
                    <pre class="code-block"># Restore latest snapshot to original location:
sudo tmctl restore hostname.example.com

# Restore specific snapshot:
sudo tmctl restore hostname.example.com --snapshot 2026-02-10

# Restore to a different directory:
sudo tmctl restore hostname.example.com --target /tmp/restore

# Restore only databases:
sudo tmctl restore hostname.example.com --db-only</pre>
                </div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <h2>&#x1F527; Server Configuration</h2>
                </div>
                <div class="help-content">
                    <h3>Per-server options</h3>
                    <p>Each server in <code>config/servers.conf</code> can have these options (also editable via the UI):</p>
                    <table class="help-table">
                        <thead><tr><th>Option</th><th>Description</th><th>Example</th></tr></thead>
                        <tbody>
                            <tr><td><code>--priority N</code></td><td>Backup order (1 = first, default 10)</td><td><code>--priority 1</code></td></tr>
                            <tr><td><code>--files-only</code></td><td>Skip database backup</td><td></td></tr>
                            <tr><td><code>--db-only</code></td><td>Skip file backup</td><td></td></tr>
                            <tr><td><code>--no-rotate</code></td><td>Keep all snapshots (no auto-delete)</td><td></td></tr>
                            <tr><td><code>--db-interval Xh</code></td><td>Extra DB-only backups every X hours</td><td><code>--db-interval 4h</code></td></tr>
                            <tr><td><code>--notify EMAIL</code></td><td>Extra notification recipient</td><td><code>--notify admin@example.com</code></td></tr>
                        </tbody>
                    </table>

                    <h3>Exclude files from backup</h3>
                    <p>You can exclude files and directories from backups using rsync exclude patterns. There are two levels:</p>
                    <table class="help-table">
                        <thead><tr><th>Level</th><th>File</th><th>Applies to</th></tr></thead>
                        <tbody>
                            <tr><td><strong>Global</strong></td><td><code>config/exclude.conf</code></td><td>All servers</td></tr>
                            <tr><td><strong>Per-server</strong></td><td><code>config/exclude.&lt;hostname&gt;.conf</code></td><td>One server only (additive)</td></tr>
                        </tbody>
                    </table>
                    <p class="help-note">Per-server excludes are <em>added</em> to the global excludes &mdash; they do not replace them. You can edit both from <em>Settings</em> &rarr; <em>Exclude Patterns</em>.</p>

                    <h4>Syntax (rsync exclude format)</h4>
                    <table class="help-table">
                        <thead><tr><th>Pattern</th><th>What it excludes</th></tr></thead>
                        <tbody>
                            <tr><td><code>/path</code></td><td>Absolute path from filesystem root</td></tr>
                            <tr><td><code>dir/</code></td><td>Any directory named <code>dir</code> anywhere</td></tr>
                            <tr><td><code>*.ext</code></td><td>All files with extension <code>.ext</code></td></tr>
                            <tr><td><code>/var/log/*.gz</code></td><td>Gzipped logs in <code>/var/log</code></td></tr>
                            <tr><td><code># comment</code></td><td>Lines starting with <code>#</code> are ignored</td></tr>
                        </tbody>
                    </table>
                    <pre class="code-block"># Example: exclude caches, logs, and Docker data
/tmp
/var/cache
/var/log
/var/lib/docker
*.swap
node_modules/
__pycache__/</pre>

                    <h3>CLI commands</h3>
                    <table class="help-table">
                        <thead><tr><th>Command</th><th>Description</th></tr></thead>
                        <tbody>
                            <tr><td><code>tmctl status</code></td><td>Show service status</td></tr>
                            <tr><td><code>tmctl servers</code></td><td>List configured servers</td></tr>
                            <tr><td><code>tmctl server add &lt;host&gt;</code></td><td>Add a server</td></tr>
                            <tr><td><code>tmctl backup &lt;host&gt;</code></td><td>Start a backup</td></tr>
                            <tr><td><code>tmctl restore &lt;host&gt;</code></td><td>Restore from backup</td></tr>
                            <tr><td><code>tmctl snapshots &lt;host&gt;</code></td><td>List snapshots</td></tr>
                            <tr><td><code>tmctl logs [host]</code></td><td>View logs</td></tr>
                            <tr><td><code>tmctl setup-web</code></td><td>Configure Nginx + SSL + Auth</td></tr>
                            <tr><td><code>tmctl update</code></td><td>Update to latest version</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

        </div>

    </main>

    <footer>
        <p>TimeMachine Backup <span id="version">--</span> &mdash; <span id="refresh-time">--</span></p>
    </footer>

    <div id="toast-container"></div>

    <div id="modal-overlay" class="modal-overlay hidden" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-title">Details</h3>
                <button class="btn btn-sm" onclick="closeModal()">&#x2715;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
